<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mappool Suggestions</title>
  <link rel="stylesheet" href="Bountiestyl.css" />
  <style>
    .btn-primary { background-color: #8e44ad; }
    .btn-primary:hover { background-color: #9b59b6; }
    h1 { color: #9b59b6; }
  </style>
</head>
<body>
  <nav>
    <a href="/">üí∞ Submit Bounties</a>
    <a href="/admin" class="active">üìù Mappool Suggestions</a>
    <a href="/community">üìå Vote & Browse</a>
  </nav>

  <div class="container">
    <div class="header">
      <h1>Mappool Suggestion</h1>
      <p>Suggest a map for the upcoming tournament pool.</p>
    </div>

    <div class="form-section">
      <div class="form-grid">
        <div class="form-group">
          <label>Beatmap URL</label>
          <input id="url" placeholder="https://osu.ppy.sh/beatmapsets/...#osu/..." />
        </div>
        <div class="form-group">
          <label>Slot</label>
          <input id="slot" placeholder="e.g. NM1, HD2, HR3" />
        </div>
        <div class="form-group">
          <label>Mod</label>
          <select id="mod">
            <option value="">Select Mod</option>
            <option value="NM">NM (No Mod)</option>
            <option value="HD">HD (Hidden)</option>
            <option value="HR">HR (Hard Rock)</option>
            <option value="FM">FM (FreeMod)</option>
            <option value="DT">DT (Double Time)</option>
            <option value="TB">TB (Tiebreaker)</option>
            <option value="EZ">EZ (Easy)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Skill Focus</label>
          <input id="skill" placeholder="e.g. Aim / Low AR / Speed / Technical" />
        </div>
        <div class="form-group">
          <label>Notes / Comments</label>
          <input id="notes" placeholder="Additional notes or comments about this beatmap" />
        </div>
        <div class="form-group">
          <label>Song Title</label>
          <input id="title" readonly />
        </div>
      </div>

      <div class="stats-grid">
        <div class="form-group">
          <label>Stars</label>
          <input id="stars" readonly />
        </div>
        <div class="form-group">
          <label>CS</label>
          <input id="cs" readonly />
        </div>
        <div class="form-group">
          <label>AR</label>
          <input id="ar" readonly />
        </div>
        <div class="form-group">
          <label>OD</label>
          <input id="od" readonly />
        </div>
        <div class="form-group">
          <label>BPM</label>
          <input id="bpm" readonly />
        </div>
        <div class="form-group">
          <label>Length</label>
          <input id="length" readonly />
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" id="addSuggestionBtn">üìù Submit Suggestion</button>
      </div>
    </div>
  </div>
  
  <div id="user-registration-modal">
    <div class="modal-content">
      <h2>üëã Welcome!</h2>
      <p>Please enter a display name to submit suggestions.</p>
      <form id="registration-form">
        <input type="text" id="username-input" placeholder="Username" required minlength="3" maxlength="20" autocomplete="off">
        <br>
        <button type="submit">Start Browsing</button>
      </form>
    </div>
  </div>
  
  <script>
    // --- Helper Functions ---
    function extractId(url) {
      const match = url.match(/osu\/(\d+)/);
      return match ? match[1] : null;
    }

    function fetchInfo() {
      const id = extractId(document.getElementById("url").value);
      if (!id) return;

      const inputs = ['title', 'stars', 'cs', 'ar', 'od', 'bpm', 'length'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        el.value = 'Loading...';
        el.classList.add('loading');
      });

      fetch("/api/beatmap/" + id)
        .then(r => r.json())
        .then(d => {
          document.getElementById("title").value = d.title;
          document.getElementById("stars").value = d.stars.replace("‚òÖ", "");
          document.getElementById("cs").value = d.cs ?? "N/A";
          document.getElementById("ar").value = d.ar ?? "N/A";
          document.getElementById("od").value = d.od ?? "N/A";
          document.getElementById("bpm").value = d.bpm ?? "N/A";
          document.getElementById("length").value = d.length ?? "N/A";

          window.currentBeatmapData = {
            preview_url: d.preview_url || "/",
            cover_url: d.cover_url || "",
            download_url: d.url || "#",
            length: d.length || "N/A"
          };

          inputs.forEach(id => document.getElementById(id).classList.remove('loading'));
        })
        .catch(err => {
          console.error("Beatmap fetch failed:", err);
          inputs.forEach(id => {
            const el = document.getElementById(id);
            el.value = '';
            el.classList.remove('loading');
          });
        });
    }

    async function addSuggestion() {
      const userId = localStorage.getItem('act_user_id');
      const username = localStorage.getItem('act_username');

      if (!userId) {
        alert("Please register a name first!");
        document.getElementById('user-registration-modal').style.display = 'flex';
        return;
      }

      const entry = {
        url: document.getElementById("url").value,
        skill: document.getElementById("skill").value,
        mod: document.getElementById("mod").value,
        slot: document.getElementById("slot").value,
        notes: document.getElementById("notes").value,
        title: document.getElementById("title").value,
        stars: document.getElementById("stars").value,
        cs: document.getElementById("cs").value,
        ar: document.getElementById("ar").value,
        od: document.getElementById("od").value,
        bpm: document.getElementById("bpm").value,
        length: document.getElementById("length").value,
        preview_url: window.currentBeatmapData?.preview_url || "/",
        cover_url: window.currentBeatmapData?.cover_url || "",
        type: "suggestion", // <--- IMPORTANT: Type set to suggestion
        submitted_by: userId,
        submitted_by_name: username || "Unknown"
      };

      if (!entry.url || !entry.slot) {
        alert("Please fill in the Beatmap URL and Slot.");
        return;
      }

      const btn = document.getElementById('addSuggestionBtn');
      btn.disabled = true;
      btn.innerText = "Submitting...";

      try {
        const response = await fetch('/api/beatmaps/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(entry)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            sendToDiscord(entry);
            alert('Suggestion Submitted Successfully!');
            
            // Clear inputs
            ['url','skill','mods','slot','notes','title','stars','cs','ar','od','bpm','length'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById("mod").selectedIndex = 0;
            window.currentBeatmapData = null;
            
        } else {
            alert('Error: ' + (result.error || "Unknown error"));
        }

      } catch (err) {
        console.error(err);
        alert('Failed to connect to server');
      } finally {
        btn.disabled = false;
        btn.innerText = "üìù Submit Suggestion";
      }
    }

    function sendToDiscord(entry) {
      fetch("/api/send-discord", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(entry)
      }).catch(err => console.error("Discord error:", err));
    }

    // --- Page Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        document.getElementById('url').addEventListener('blur', fetchInfo);
        document.getElementById('addSuggestionBtn').addEventListener('click', addSuggestion);

        // User Check
        const userId = localStorage.getItem('act_user_id');
        const modal = document.getElementById('user-registration-modal');
        
        if (!userId) {
            modal.style.display = 'flex';
        }

        // Registration Logic
        document.getElementById('registration-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username-input').value.trim();
            if (username.length < 3) return alert('Name too short!');

            try {
                const response = await fetch('/api/users/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ display_name: username })
                });
                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('act_user_id', data.id);
                    localStorage.setItem('act_username', data.display_name);
                    modal.style.display = 'none';
                    alert(`Welcome, ${data.display_name}!`);
                } else {
                    alert(data.error || 'Registration failed');
                }
            } catch (error) {
                console.error(error);
                alert('Failed to connect to server.');
            }
        });
    });
  </script>
</body>
</html>
