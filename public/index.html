<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bounties</title>
  <link rel="stylesheet" href="Bountiestyl.css" />
</head>
<body>
  <nav>
    <a href="admin.html">Mappool suggestions</a>
  </nav>

  <div class="container">
    <div class="header">
      <h1>Bounties Submission</h1>
      <p>Players can submit challenges for specific maps</p>
    </div>

    <div class="form-section">
      <div class="form-grid">
        <div class="form-group">
          <label>Beatmap URL</label>
          <input id="url" placeholder="https://osu.ppy.sh/beatmapsets/...#osu/..." />
        </div>
        <div class="form-group">
          <label>Challenge</label>
          <input id="challenge" placeholder="e.g. FC, #1 Algeria, Best Acc" />
        </div>
        <div class="form-group">
          <label>Mods</label>
          <input id="mods" placeholder="e.g. NM, HD, HR, DT" />
        </div>
        <div class="form-group">
          <label>Map Difficulty</label>
          <input id="difficulty" placeholder="e.g. Insane, Expert" />
        </div>
        <div class="form-group">
          <label>Song Title</label>
          <input id="title" readonly />
        </div>
      </div>

      <div class="stats-grid">
        <div class="form-group">
          <label>Stars</label>
          <input id="stars" readonly />
        </div>
        <div class="form-group">
          <label>CS</label>
          <input id="cs" readonly />
        </div>
        <div class="form-group">
          <label>AR</label>
          <input id="ar" readonly />
        </div>
        <div class="form-group">
          <label>OD</label>
          <input id="od" readonly />
        </div>
        <div class="form-group">
          <label>BPM</label>
          <input id="bpm" readonly />
        </div>
        <div class="form-group">
          <label>Length</label>
          <input id="length" readonly />
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" id="addBountyBtn">â• Submit Bounty</button>
      </div>
    </div>

    <div class="output-section">
      <h2 class="section-title">ğŸ“¦ Current Bounties (<span id="count">0</span>)</h2>
      <div id="output"></div>
    </div>
  </div>
  
      <div id="user-registration-modal">
    <div class="modal-content">
      <h2>ğŸ‘‹ Welcome!</h2>
      <p>Please enter a display name to vote and submit maps.</p>
      <form id="registration-form">
        <input type="text" id="username-input" placeholder="Username (e.g. Cookiezi)" required minlength="3" maxlength="20" autocomplete="off">
        <br>
        <button type="submit">Start Browsing</button>
      </form>
    </div>
  </div>
  
  <script>
    let bounties = [];
    const saved = localStorage.getItem("bounties");
    if (saved) {
      bounties = JSON.parse(saved);
      renderOutput();
    }

// Add event listeners
document.getElementById('url').addEventListener('blur', fetchInfo);
document.getElementById('addBountyBtn').addEventListener('click', addBounty);

// Event delegation for dynamic buttons
document.getElementById('output').addEventListener('click', function(e) {
  if (e.target.classList.contains('btn-edit') || e.target.closest('.btn-edit')) {
    const btn = e.target.classList.contains('btn-edit') ? e.target : e.target.closest('.btn-edit');
    const index = parseInt(btn.dataset.index);
    editBounty(index);
  }
  
  if (e.target.classList.contains('btn-delete') || e.target.closest('.btn-delete')) {
    const btn = e.target.classList.contains('btn-delete') ? e.target : e.target.closest('.btn-delete');
    const index = parseInt(btn.dataset.index);
    deleteBounty(index);
  }
  
  if (e.target.classList.contains('btn-preview') || e.target.closest('.btn-preview')) {
    const btn = e.target.classList.contains('btn-preview') ? e.target : e.target.closest('.btn-preview');
    const previewUrl = btn.dataset.previewUrl;
    playBountyPreview(previewUrl);
  }
});

    function extractId(url) {
      const match = url.match(/osu\/(\d+)/);
      return match ? match[1] : null;
    }

    function extractSetId(url) {
      const match = url.match(/beatmapsets\/(\d+)/);
      return match ? match[1] : null;
    }

    function fetchInfo() {
      const id = extractId(document.getElementById("url").value);
      const setId = extractSetId(document.getElementById("url").value);
      if (!id) return;

      const inputs = ['title', 'stars', 'cs', 'ar', 'od', 'bpm', 'length'];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        el.value = 'Loading...';
        el.classList.add('loading');
      });

      fetch("/api/beatmap/" + id)
        .then(r => r.json())
        .then(d => {
          document.getElementById("title").value = d.title;
          document.getElementById("stars").value = d.stars.replace("â˜…", "");
          document.getElementById("cs").value = d.cs ?? "N/A";
          document.getElementById("ar").value = d.ar ?? "N/A";
          document.getElementById("od").value = d.od ?? "N/A";
          document.getElementById("bpm").value = d.bpm ?? "N/A";
          document.getElementById("length").value = d.length ?? "N/A";

          window.currentBeatmapData = {
            preview_url: d.preview_url || "/",
            cover_url: d.cover_url || "",
            download_url: d.url || "#",
            length: d.length || "N/A"
          };

          inputs.forEach(id => document.getElementById(id).classList.remove('loading'));
        })
        .catch(err => {
          console.error("Beatmap fetch failed:", err);
          inputs.forEach(id => {
            const el = document.getElementById(id);
            el.value = '';
            el.classList.remove('loading');
          });
        });
    }

    function addBounty() {
      const entry = {
        url: document.getElementById("url").value,
        challenge: document.getElementById("challenge").value,
        mods: document.getElementById("mods").value,
        difficulty: document.getElementById("difficulty").value,
        title: document.getElementById("title").value,
        stars: document.getElementById("stars").value,
        cs: document.getElementById("cs").value,
        ar: document.getElementById("ar").value,
        od: document.getElementById("od").value,
        bpm: document.getElementById("bpm").value,
        length: document.getElementById("length").value,
        preview_url: window.currentBeatmapData?.preview_url || "/",
        cover_url: window.currentBeatmapData?.cover_url || "",
        download_url: window.currentBeatmapData?.download_url || "",
        type: "bounty"
      };

      if (!entry.url || !entry.challenge) {
        alert("Please fill in the Beatmap URL and Challenge.");
        return;
      }

      bounties.push(entry);
      localStorage.setItem("bounties", JSON.stringify(bounties));
      sendToDiscord(entry);
      renderOutput();

      ['url','challenge','mods','difficulty','title','stars','cs','ar','od','bpm','length'].forEach(id => {
        document.getElementById(id).value = '';
      });
      window.currentBeatmapData = null;
    }

    function sendToDiscord(entry) {
      fetch("/api/send-discord", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(entry)
      })
      .then(r => r.json())
      .then(data => console.log("âœ… Bounty sent to Discord:", data))
      .catch(err => console.error("âŒ Discord error:", err));
    }

    function renderOutput() {
      const out = document.getElementById("output");
      const count = document.getElementById("count");

      count.textContent = bounties.length;
      out.innerHTML = "";

      bounties.forEach((b, i) => {
        out.innerHTML += `
          <div class="beatmap-card">
            ${b.cover_url ? `<img src="${b.cover_url}" class="cover-image">` : ''}
            <div class="beatmap-header">
              <div><strong>${b.title}</strong></div>
              <div style="font-size:0.85rem;color:#94a3b8;">${b.mods} | ${b.difficulty}</div>
            </div>
            <div style="margin-top:0.25rem;">ğŸ¯ Challenge: ${b.challenge}</div>
            <div class="beatmap-stats">
              <div class="stat-item"><span class="stat-label">Stars</span><span class="stat-value">${b.stars}</span></div>
              <div class="stat-item"><span class="stat-label">CS</span><span class="stat-value">${b.cs}</span></div>
              <div class="stat-item"><span class="stat-label">AR</span><span class="stat-value">${b.ar}</span></div>
              <div class="stat-item"><span class="stat-label">OD</span><span class="stat-value">${b.od}</span></div>
              <div class="stat-item"><span class="stat-label">BPM</span><span class="stat-value">${b.bpm}</span></div>
              <div class="stat-item"><span class="stat-label">Length</span><span class="stat-value">${b.length}</span></div>
            </div>
            <div class="beatmap-actions" style="margin-top:0.5rem;">
              <button class="btn-small btn-edit" data-index="${i}">âœï¸ Edit</button>
              <button class="btn-small btn-delete" data-index="${i}">ğŸ—‘ï¸ Delete</button>
              ${b.preview_url && b.preview_url !== "/" ? `<button class="btn-small btn-preview" data-preview-url="${b.preview_url}">ğŸ”Š Preview</button>` : ''}
            </div>
          </div>
        `;
      });
    }

    function editBounty(index) {
      const bounty = bounties[index];

      document.getElementById("url").value = bounty.url;
      document.getElementById("challenge").value = bounty.challenge;
      document.getElementById("mods").value = bounty.mods;
      document.getElementById("difficulty").value = bounty.difficulty;
      document.getElementById("title").value = bounty.title;
      document.getElementById("stars").value = bounty.stars;
      document.getElementById("cs").value = bounty.cs;
      document.getElementById("ar").value = bounty.ar;
      document.getElementById("od").value = bounty.od;
      document.getElementById("bpm").value = bounty.bpm;
      document.getElementById("length").value = bounty.length;

      window.currentBeatmapData = {
        preview_url: bounty.preview_url,
        cover_url: bounty.cover_url,
        download_url: bounty.download_url
      };

      bounties.splice(index, 1);
      localStorage.setItem("bounties", JSON.stringify(bounties));
      renderOutput();

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteBounty(index) {
      if (confirm("Delete this bounty?")) {
        bounties.splice(index, 1);
        localStorage.setItem("bounties", JSON.stringify(bounties));
        renderOutput();
      }
    }

    let currentBountyAudio = null;
    function playBountyPreview(previewUrl) {
      if (currentBountyAudio) currentBountyAudio.pause();
      currentBountyAudio = new Audio(previewUrl);
      currentBountyAudio.volume = 0.5;
      currentBountyAudio.play().catch(e => {
        console.error("Preview error:", e);
        alert("Could not play preview.");
      });
      setTimeout(() => {
        if (currentBountyAudio) {
          currentBountyAudio.pause();
          currentBountyAudio = null;
        }
      }, 30000);
    }
  </script>
</body>
</html>
