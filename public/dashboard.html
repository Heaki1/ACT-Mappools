<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="Bountiestyl.css" />
  <style>
    .login-box { max-width: 300px; margin: 50px auto; text-align: center; }
    .login-box input { width: 100%; padding: 10px; margin-bottom: 10px; background: #333; border: 1px solid #555; color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
    th { color: #ff66aa; }
    .btn-del { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    .btn-del:hover { background: #c0392b; }
  </style>
</head>
<body>
  <nav>
    <a href="/">‚ûï Submit Bounties</a>
    <a href="/admin">üìù Suggestions</a>
    <a href="/community">üó≥Ô∏è Vote</a>
    <a href="/dashboard" class="active">üîê Dashboard</a>
  </nav>

  <div class="container">
    <h1>Admin Dashboard</h1>

    <div id="login-section" class="login-box">
      <h3>Enter Admin Password</h3>
      <input type="password" id="admin-pass" placeholder="Password...">
      <button class="btn btn-primary" onclick="login()">Login</button>
    </div>

    <div id="admin-panel" style="display:none;">
      <p>Manage all community submissions.</p>
      <div style="overflow-x:auto;">
        <tbody id="map-table-body">
            </tbody>
        <table id="map-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Title</th>
              <th>Submitter</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    let adminToken = sessionStorage.getItem('act_admin_pass');

    document.addEventListener('DOMContentLoaded', () => {
      if (adminToken) {
        showPanel();
      }
    });

    async function login() {
      const pass = document.getElementById('admin-pass').value;
      try {
        const res = await fetch('/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pass })
        });
        
        if (res.ok) {
          adminToken = pass; // Store simple password locally for requests
          sessionStorage.setItem('act_admin_pass', pass);
          showPanel();
        } else {
          alert("Wrong password!");
        }
      } catch (e) { alert("Error connecting"); }
    }

    function showPanel() {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'block';
      loadMaps();
    }

    async function loadMaps() {
      const res = await fetch('/api/beatmaps/list');
      const maps = await res.json();
      const tbody = document.querySelector('#map-table tbody');
      tbody.innerHTML = '';

      maps.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span style="color:${m.type === 'bounty' ? '#f1c40f' : '#8e44ad'}">${m.type}</span></td>
          <td><a href="${m.url}" target="_blank" style="color:white;text-decoration:none;">${m.title}</a></td>
          <td>${m.submitted_by ? (m.submitted_by.substring(0,5)+'...') : 'Anon'}</td>
          <td>
            <button class="btn-del" onclick="deleteMap(${m.id})">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function deleteMap(id) {
      if(!confirm("Are you sure you want to delete this map? This cannot be undone.")) return;

      try {
        const res = await fetch(`/api/beatmaps/${id}`, {
          method: 'DELETE',
          headers: { 'x-admin-password': adminToken }
        });
        if(res.ok) {
          loadMaps();
        } else {
          alert("Failed to delete. Check password.");
        }
      } catch(e) { alert("Error"); }
    }
  </script>
</body>
</html>
