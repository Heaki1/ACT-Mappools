<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ACT Players suggestions</title>
  <link rel="stylesheet" href="adminstyle.css" />
</head>
<body>
  <nav>
    <a href="Tournament TDLR.html">TL;DR</a> |
    <a href="index.html">Mappool</a>
  </nav>

  <div class="container">
    <div class="header">
      <h1>ACT Players suggestion</h1>
      <p>Beatmaps Selector</p>
    </div>

    <div class="form-section">
      <div class="form-grid">
        <div class="form-group">
          <label>Beatmap URL</label>
          <input id="url" placeholder="https://osu.ppy.sh/beatmapsets/...#osu/..." onblur="fetchInfo()" />
        </div>
        <div class="form-group">
          <label>Slot</label>
          <input id="slot" placeholder="e.g. NM1, HD2, HR3" />
        </div>
        <div class="form-group">
          <label>Mod</label>
          <select id="mod">
            <option value="">Select Mod</option>
            <option value="NM">NM (No Mod)</option>
            <option value="HD">HD (Hidden)</option>
            <option value="HR">HR (Hard Rock)</option>
            <option value="FM">FM (FreeMod)</option>
            <option value="DT">DT (Double Time)</option>
            <option value="TB">TB (Tiebreaker)</option>
            <option value="EZ">EZ (Easy)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Skill Focus</label>
          <input id="skill" placeholder="e.g. Aim / Low AR / Speed / Technical" />
        </div>
        <div class="form-group">
          <label>Notes / Comments</label>
          <input id="notes" placeholder="Additional notes or comments about this beatmap" />
        </div>
        <div class="form-group">
          <label>Song Title</label>
          <input id="title" readonly />
        </div>
      </div>

      <div class="stats-grid">
        <div class="form-group">
          <label>Stars</label>
          <input id="stars" readonly />
        </div>
        <div class="form-group">
          <label>CS</label>
          <input id="cs" readonly />
        </div>
        <div class="form-group">
          <label>AR</label>
          <input id="ar" readonly />
        </div>
        <div class="form-group">
          <label>OD</label>
          <input id="od" readonly />
        </div>
        <div class="form-group">
          <label>BPM</label>
          <input id="bpm" readonly />
        </div>
        <div class="form-group">
         <label>Length</label>
         <input id="length" readonly />
        </div>
      </div>

     <div class="action-buttons">
       <button class="btn btn-primary" onclick="addToPool()">‚ûï Add to Pool</button>
       <button class="btn btn-secondary admin-only" onclick="downloadJSON()">üíæ Download JSON</button>
     </div>
    </div>

    <div class="output-section">
      <h2 class="section-title">üóÇÔ∏è Current Beatmaps (<span id="count">0</span>)</h2>
      <div id="output"></div>
    </div>
  </div>

  <script>
const BASE_URL = "https://act-mappools.onrender.com"; // your Render backend

function fetchInfo() {
  const urlInput = document.getElementById("url").value;
  const id = extractId(urlInput);
  const setId = extractSetId(urlInput);
  if (!id) return;

  const inputs = ['title', 'stars', 'cs', 'ar', 'od', 'bpm', 'length'];
  inputs.forEach(id => {
    const el = document.getElementById(id);
    el.value = 'Loading...';
    el.classList.add('loading');
  });

  fetch(`${BASE_URL}/api/beatmap/${id}`)
    .then(res => {
      if (!res.ok) throw new Error("Beatmap fetch failed");
      return res.json();
    })
    .then(d => {
      document.getElementById("title").value = d.title;
      document.getElementById("stars").value = d.stars;
      document.getElementById("cs").value = d.cs;
      document.getElementById("ar").value = d.ar;
      document.getElementById("od").value = d.od;
      document.getElementById("bpm").value = d.bpm;
      document.getElementById("length").value = d.length || "N/A";

      window.currentBeatmapData = {
        preview_url: d.preview_url || `https://b.ppy.sh/preview/${setId}.mp3`,
        cover_url: d.cover_url || `https://assets.ppy.sh/beatmaps/${setId}/covers/cover.jpg`,
        download_url: `https://osu.ppy.sh/beatmapsets/${setId}/download?noVideo=1`,
        length: d.length || "N/A"
      };

      inputs.forEach(id => {
        document.getElementById(id).classList.remove('loading');
      });
    })
    .catch(err => {
      console.error(err);
      alert("Couldn't fetch info from the beatmap URL. Please check the URL and try again.");
      inputs.forEach(id => {
        const el = document.getElementById(id);
        el.value = '';
        el.classList.remove('loading');
      });
      window.currentBeatmapData = null;
    });
}

function sendToDiscord(entry) {
  fetch(`${BASE_URL}/api/send-discord`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(entry)
  })
  .then(res => {
    if (!res.ok) throw new Error("Failed to send to Discord");
    return res.json();
  })
  .then(data => console.log("‚úÖ Beatmap sent to Discord via server:", data))
  .catch(err => {
    console.error("‚ùå Error sending to Discord via backend:", err);
    alert("Failed to send to Discord. Please check your server.");
  });
}
</script>
</body>
</html>
