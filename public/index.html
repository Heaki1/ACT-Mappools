<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ACT Mappool Manager for osu! - Organize and manage your tournament beatmap pools">
  <meta name="keywords" content="osu, ACT Mappool, mappool, beatmaps, rhythm game">
  <meta name="author" content="Heaki1">
  <meta property="og:title" content="ACT Mappool">
  <meta property="og:description" content="ACT Mappool Manager for osu! - Organize and manage your tournament beatmap pools">
  <meta property="og:type" content="website">
  <title>ACT Mappool</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="loading hidden" id="loading" aria-hidden="true">
    <div class="spinner" role="status" aria-label="Loading..."></div>
  </div>

  <div class="container">
     <div class="header">
      <h1 class="title" aria-label="OSU Tournament">OSU! Tournament</h1>
      <p aria-label="Mappool Showcase" style="color: var(--muted);">Mappool Showcase</p>
      
      <div class="stats" role="group" aria-label="Tournament Statistics">
        <div class="stat">
          <div class="stat-value" id="totalMaps" aria-label="Total Maps">0</div>
          <div class="stat-label">Maps</div>
        </div>
        </div>
        <div class="stat">
          <div class="stat-value" id="avgStars">0.0</div>
          <div class="stat-label">Avg Stars</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="totalMods">0</div>
          <div class="stat-label">Mods</div>
        </div>
      </div>
    </div>

    <div id="mappool"></div>
  </div>

  <div class="controls">
    <button class="control-btn" onclick="loadSample()" title="Sample Data">üìä</button>
    <button class="control-btn" onclick="document.getElementById('file').click()" title="Load JSON">üìÅ</button>
    <input type="file" id="file" accept=".json" style="display:none" onchange="loadFile(event)">
  </div>

  <script>
    let data = [];
    let audio = null;

    const modNames = {
      NM: 'No Mod', HD: 'Hidden', HR: 'Hard Rock', 
      DT: 'Double Time', FM: 'Free Mod', TB: 'Tiebreaker'
    };

    function loadFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      show('loading');
      const reader = new FileReader();
      reader.onload = e => {
        try {
          data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) data = [data];
          render();
          hide('loading');
        } catch (err) {
          alert('Error: ' + err.message);
          hide('loading');
        }
      };
      reader.readAsText(file);
    }

    function loadMaps() {
      show('loading');
      fetch("beatmaps.json")
        .then(r => r.json())
        .then(json => {
          data = Array.isArray(json) ? json : [json];
          render();
          hide('loading');
        })
        .catch(err => {
          console.error("Failed to load beatmaps.json:", err);
          hide('loading');
          // Fallback to sample data if beatmaps.json doesn't exist
          setTimeout(loadSample, 500);
        });
    }

    function loadSample() {
      show('loading');
      data = [
        {slot:"NM1", mod:"NM", tier:"mid", skill:"Aim Control", notes:"Warmup", title:"Kobaryo - HUG AND KILL [Embrace]", stars:"5.87", cs:"4.0", ar:"9.3", od:"8.5", bpm:"174", url:"https://osu.ppy.sh/beatmapsets/1564788#osu/3195446", preview_url:"https://b.ppy.sh/preview/1564788.mp3", cover_url:"https://assets.ppy.sh/beatmaps/1564788/covers/cover.jpg"},
        {slot:"NM2", mod:"NM", tier:"high", skill:"Speed", notes:"Fast streams", title:"xi - FREEDOM DiVE [Another]", stars:"6.43", cs:"4.0", ar:"9.5", od:"8.0", bpm:"222", url:"https://osu.ppy.sh/beatmapsets/39804#osu/126645", preview_url:"https://b.ppy.sh/preview/39804.mp3", cover_url:"https://assets.ppy.sh/beatmaps/39804/covers/cover.jpg"},
        {slot:"HD1", mod:"HD", tier:"mid", skill:"Reading", notes:"Hidden practice", title:"DragonForce - Through Fire And Flames [Myth]", stars:"5.91", cs:"4.0", ar:"9.0", od:"7.0", bpm:"200", url:"https://osu.ppy.sh/beatmapsets/20237#osu/70760", preview_url:"https://b.ppy.sh/preview/20237.mp3", cover_url:"https://assets.ppy.sh/beatmaps/20237/covers/cover.jpg"},
        {slot:"HR1", mod:"HR", tier:"high", skill:"Precision", notes:"High AR", title:"UNDEAD CORPORATION - Everything will freeze [Extra]", stars:"7.12", cs:"5.2", ar:"10.0", od:"9.0", bpm:"185", url:"https://osu.ppy.sh/beatmapsets/158023#osu/336471", preview_url:"https://b.ppy.sh/preview/158023.mp3", cover_url:"https://assets.ppy.sh/beatmaps/158023/covers/cover.jpg"},
        {slot:"DT1", mod:"DT", tier:"mid", skill:"Speed + Aim", notes:"Classic DT", title:"Demetori - Emotional Skyscraper [Extra Stage]", stars:"6.78", cs:"4.0", ar:"9.2", od:"8.0", bpm:"140", url:"https://osu.ppy.sh/beatmapsets/13223#osu/53554", preview_url:"https://b.ppy.sh/preview/13223.mp3", cover_url:"https://assets.ppy.sh/beatmaps/13223/covers/cover.jpg"},
        {slot:"TB", mod:"TB", tier:"high", skill:"Endurance", notes:"Final showdown", title:"Camellia - GHOST [Collab Extra]", stars:"7.89", cs:"4.2", ar:"9.8", od:"9.2", bpm:"160", url:"https://osu.ppy.sh/beatmapsets/1138145#osu/2377755", preview_url:"https://b.ppy.sh/preview/1138145.mp3", cover_url:"https://assets.ppy.sh/beatmaps/1138145/covers/cover.jpg"}
      ];
      setTimeout(() => { render(); hide('loading'); }, 500);
    }

        function render() {
      if (!data.length) return;
      
      // Update stats
      const total = data.length;
      const avgStars = (
        data
          .map(m => parseFloat(String(m.stars).replace(/[^\d.]/g, '')))
          .filter(n => !isNaN(n))
          .reduce((s, n) => s + n, 0) / total
      ).toFixed(1);
      const mods = [...new Set(data.map(m => m.mod))].length;
      
      document.getElementById('totalMaps').textContent = total;
      document.getElementById('avgStars').textContent = avgStars;
      document.getElementById('totalMods').textContent = mods;

      // Group by tier first, then by mod
      const groups = {
        high: {},
        mid: {}
      };

      data.forEach(map => {
        const tier = map.tier || 'mid';
        const mod = map.mod || 'NM';
        if (!groups[tier][mod]) groups[tier][mod] = [];
        groups[tier][mod].push(map);
      });

      // Render
      document.getElementById('mappool').innerHTML = `
        ${renderTier('high', groups.high)}
        ${renderTier('mid', groups.mid)}
      `;
    }
         
              function renderTier(tier, modGroups) {
      if (Object.keys(modGroups).length === 0) return '';

      const allMapsInTier = Object.values(modGroups).flat();
      const tierAvgStars = (
        allMapsInTier
          .map(m => parseFloat(String(m.stars).replace(/[^\d.]/g, '')))
          .filter(n => !isNaN(n))
          .reduce((s, n) => s + n, 0) / allMapsInTier.length
      ).toFixed(1);

      return `
        <div class="tier-section">
          <div class="tier-header">
            <h2 class="tier-title ${tier}-tier">
              ${tier.charAt(0).toUpperCase() + tier.slice(1)} Tier
              <span style="font-size: 0.9rem; color: var(--muted);">
                ${allMapsInTier.length} maps ‚Ä¢ Avg Stars: ${tierAvgStars}
              </span>
            </h2>
          </div>
          ${Object.entries(modGroups).map(([mod, maps]) => `
            <div class="mod-section">
              <div class="mod-header">
                <div class="mod-icon mod-${mod.toLowerCase()}">${mod}</div>
                <div class="mod-title">${modNames[mod] || mod}</div>
              </div>
              <div class="maps-grid">
                ${maps.map(createCard).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function createCard(map) {
      // Helper function to format the download URL
      const getDownloadUrl = (url) => {
      const match = url.match(/beatmapsets\/(\d+)/);
     return match ? `https://osu.ppy.sh/beatmapsets/${match[1]}/download?noVideo=1` : url;
    };


      return `

            <div class="map-card">
            <div class="map-info">
            <div style="position: relative;">
              <img src="${map.cover_url || ''}" class="map-cover" onerror="this.style.background='linear-gradient(135deg, #1a1a3e, #0f0f23)'; this.style.display='flex'; this.style.alignItems='center';">
              <div class="map-overlay">
                <div class="slot-badge">${map.slot}</div>
                <div class="tier-badge tier-${map.tier}">${map.tier.toUpperCase()}</div>
              </div>
            </div>
            
            <div class="map-content">
              <h3 class="map-title">${map.title}</h3>
              
              <div class="map-stats">
                <div class="stat-item">
                  <span class="stat-val stars">${map.stars}</span>
                  <span class="stat-lbl">Stars</span>
                </div>
                <div class="stat-item">
                  <span class="stat-val">${map.cs}</span>
                  <span class="stat-lbl">CS</span>
                </div>
                <div class="stat-item">
                  <span class="stat-val">${map.ar}</span>
                  <span class="stat-lbl">AR</span>
                </div>
                <div class="stat-item">
                  <span class="stat-val">${map.od}</span>
                  <span class="stat-lbl">OD</span>
                </div>
                <div class="stat-item">
                  <span class="stat-val">${map.bpm}</span>
                  <span class="stat-lbl">BPM</span>
                </div>
              </div>

              <div class="map-tags">
                ${map.skill ? `<span class="tag skill-tag">üéØ ${map.skill}</span>` : ''}
                ${map.notes ? `<span class="tag note-tag">üìù ${map.notes}</span>` : ''}
              </div>
            </div>
          </div>

          <div class="map-actions">
            ${map.preview_url && map.preview_url !== '/' ? 
              `<button class="btn btn-play" onclick="play('${map.preview_url}')">üîä Preview</button>` : ''}
            <button class="btn btn-download" onclick="downloadMap('${getDownloadUrl(map.url)}')">üì• Download</button>
          </div>
        </div>
      `;
    }
    
    function downloadMap(url) {
      const a = document.createElement('a');
      a.href = url;
      a.download = ''; // optional: specify a filename
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function play(url) {
      if (audio) audio.pause();
      
      const btn = event.target;
      btn.classList.add('preview-loading');
      
      audio = new Audio(url);
      audio.volume = 0.5;
      
      audio.addEventListener('canplaythrough', () => {
        btn.classList.remove('preview-loading');
      });
      
      audio.addEventListener('error', () => {
        btn.classList.remove('preview-loading');
        alert("Could not play preview");
      });
      
      audio.play().catch(() => {
        btn.classList.remove('preview-loading');
        alert("Could not play preview");
      });
      
      setTimeout(() => {
        if (audio) audio.pause();
        btn.classList.remove('preview-loading');
      }, 30000);
    }

    function show(id) { document.getElementById(id).classList.remove('hidden'); }
    function hide(id) { document.getElementById(id).classList.add('hidden'); }

    // Auto-load from beatmaps.json or fallback to sample data
    document.addEventListener('DOMContentLoaded', () => {
      loadMaps();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && audio) {
        audio.pause();
        audio = null;
      }
    });
  </script>
</body>
</html>
