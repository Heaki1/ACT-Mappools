<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tournament Mappool</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="loading hidden" id="loading">
    <div class="spinner"></div>
  </div>

  <div class="container">
    <div class="header">
      <h1 class="title">OSU! Tournament</h1>
      <p style="color: var(--muted);">Mappool Showcase</p>
      
      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="totalMaps">0</div>
          <div class="stat-label">Maps</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="avgStars">0.0</div>
          <div class="stat-label">Avg Stars</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="totalMods">0</div>
          <div class="stat-label">Mods</div>
        </div>
      </div>
    </div>

    <div id="mappool"></div>
  </div>

  <div class="controls">
    <button class="control-btn" onclick="document.getElementById('file').click()" title="Load JSON">üìÅ</button>
    <input type="file" id="file" accept=".json" style="display:none" onchange="loadFile(event)">
  </div>

  <script>
    let data = [];
    let audio = null;

    const modNames = {
      NM: 'No Mod', HD: 'Hidden', HR: 'Hard Rock', 
      DT: 'Double Time', FM: 'Free Mod', TB: 'Tiebreaker'
    };

    function loadFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      show('loading');
      const reader = new FileReader();
      reader.onload = e => {
        try {
          data = JSON.parse(e.target.result);
          if (!Array.isArray(data)) data = [data];
          render();
          hide('loading');
        } catch (err) {
          alert('Error: ' + err.message);
          hide('loading');
        }
      };
      reader.readAsText(file);
    }

    function loadMaps() {
      show('loading');
      fetch("beatmaps.json")
        .then(r => r.json())
        .then(json => {
          data = Array.isArray(json) ? json : [json];
          render();
          hide('loading');
        })
        .catch(err => {
          console.error("Failed to load beatmaps.json:", err);
          hide('loading');
        });
    }

    function render() {
      if (!data.length) return;
      
      // Update stats
      const total = data.length;
      const avgStars = (
        data
          .map(m => parseFloat(String(m.stars).replace(/[^\d.]/g, '')))
          .filter(n => !isNaN(n))
          .reduce((s, n) => s + n, 0) / total
      ).toFixed(1);
      const mods = [...new Set(data.map(m => m.mod))].length;
      
      document.getElementById('totalMaps').textContent = total;
      document.getElementById('avgStars').textContent = avgStars;
      document.getElementById('totalMods').textContent = mods;

      // Group by mod
      const groups = {};
      data.forEach(map => {
        const mod = map.mod || 'NM';
        if (!groups[mod]) groups[mod] = [];
        groups[mod].push(map);
      });

      // Render
      document.getElementById('mappool').innerHTML = Object.entries(groups)
        .map(([mod, maps]) => {
          const modAvgStars = (
            maps
              .map(m => parseFloat(String(m.stars).replace(/[^\d.]/g, '')))
              .filter(n => !isNaN(n))
              .reduce((s, n) => s + n, 0) / maps.length
          ).toFixed(1);
          
          return `
            <div class="mod-section">
              <div class="mod-header">
                <div class="mod-icon mod-${mod.toLowerCase()}">${mod}</div>
                <div>
                  <div class="mod-title">${modNames[mod] || mod}</div>
                  <div style="color: var(--muted); font-size: 0.9rem;">
                    ${maps.length} map${maps.length !== 1 ? 's' : ''} ‚Ä¢ Avg Stars: ${modAvgStars}
                  </div>
                </div>
              </div>
              <div class="maps-grid">
                ${maps.map(createCard).join('')}
              </div>
            </div>
          `;
        }).join('');
    }

    function createCard(map) {
      return `
        <div class="map-card" onclick="open('${map.url}')">
          <div style="position: relative;">
            <img src="${map.cover_url || ''}" class="map-cover" onerror="this.style.background='linear-gradient(135deg, #1a1a3e, #0f0f23)'">
            <div class="map-overlay">
              <div class="slot-badge">${map.slot}</div>
              <div class="tier-badge tier-${map.tier}">${map.tier.toUpperCase()}</div>
            </div>
          </div>
          
          <div class="map-content">
            <h3 class="map-title">${map.title}</h3>
            
            <div class="map-stats">
              <div class="stat-item">
                <span class="stat-val stars">‚≠ê${map.stars}</span>
                <span class="stat-lbl">Stars</span>
              </div>
              <div class="stat-item">
                <span class="stat-val">${map.cs}</span>
                <span class="stat-lbl">CS</span>
              </div>
              <div class="stat-item">
                <span class="stat-val">${map.ar}</span>
                <span class="stat-lbl">AR</span>
              </div>
              <div class="stat-item">
                <span class="stat-val">${map.od}</span>
                <span class="stat-lbl">OD</span>
              </div>
              <div class="stat-item">
                <span class="stat-val">${map.bpm}</span>
                <span class="stat-lbl">BPM</span>
              </div>
            </div>

            <div class="map-tags">
              ${map.skill ? `<span class="tag skill-tag">üéØ ${map.skill}</span>` : ''}
              ${map.notes ? `<span class="tag note-tag">üìù ${map.notes}</span>` : ''}
            </div>

            <div class="map-actions" onclick="event.stopPropagation()">
              ${map.preview_url && map.preview_url !== '/' ? 
                `<button class="btn btn-play" onclick="play('${map.preview_url}')">üîä Preview</button>` : ''}
              <button class="btn btn-download" onclick="open('${map.url}')">üì• Download</button>
            </div>
          </div>
        </div>
      `;
    }

    function play(url) {
      if (audio) audio.pause();
      audio = new Audio(url);
      audio.volume = 0.5;
      audio.play().catch(() => alert("Could not play preview"));
      setTimeout(() => { if (audio) audio.pause(); }, 30000);
    }

    function show(id) { document.getElementById(id).classList.remove('hidden'); }
    function hide(id) { document.getElementById(id).classList.add('hidden'); }
    function open(url) { window.open(url, '_blank'); }

    // Load data from beatmaps.json on page load
    document.addEventListener('DOMContentLoaded', loadMaps);

    // Keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && audio) {
        audio.pause();
        audio = null;
      }
    });
  </script>
</body>
</html>
